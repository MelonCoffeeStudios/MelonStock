<% include fullHead.ejs %>


<script src="/static/js/plotly.js"></script>

<main>

        <div class="col-md-7" >
            <div class="row" name="graphs">
                <div id="tester" style="width:100%;height:40vh;"></div>
            </div>
            <div class="row" name="info" style="max-height: 50vh;overflow-y: scroll">
                <div class="col-md-8">
                    <div class="panel-group" name="DayPanels">

                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="row" name="controls" style="height: 10vh;">
                <button name="runSim">Run Simulation! (Save)</button>
                <button name="sumAndPercent">Sum and Percent Stocks</button>
                <button name="displayDeps">Display Department Sales</button>
                <button name="getBarcodeSales">Get Barcode Sales</button>
            </div>
            <div class="row" style="max-height: 60vh;overflow-y: scroll">
                <div>
                    Current Date: <span name="simTimeLog">N/A</span>
                </div>
                <table class="table table-striped table-condensed" >
                    <thead>
                    <th>Time</th>
                    <th>Message</th>
                    </thead>
                    <tbody name="bant">

                    </tbody>
                </table>
            </div>
        </div>
    </div>


</main>



<script>

    TESTER = document.getElementById('tester');


    var socket = io.connect();

    socket.emit("join", "sim-logs")

    socket.on("connect", function (data) {
        console.log(data);
    });

    $("[name=runSim]").click(function () {
        plotx=[];
        ploty=[];
        $.post("/sim/runSim").done(function (data) {
            console.log(data);
        })
    })

    $("[name=sumAndPercent]").click(function () {
        $.post("/sim/sumAndPercent").done(function (data) {
            console.log(data);
        })
    })

    $("[name=displayDeps]").click(function () {
        var Sales = [];
        $.get("/sim/allSales", function (AllSales) {
            AllSales.forEach(function (Sale) {
                Sale.items.forEach(function (item){
                    Sales[item.dep].push(item)
                })
            })
            console.log(Sales);
        })
    })

    $("[name=getBarcodeSales]").click(function () {
        var bc = prompt("Which Barcode?");
        $.post("/sim/salesPerBarcode", {barcode: bc},function (data) {
            console.log(data);
        })
    })

    socket.on("simTimeLog", function (data) {
        var bar = $("[name=simTimeLog]");
        var str = data.simDate + ", " + FormatNumberLength(data.simTime,2) + ":00"
        console.log(data);

        bar.text(str)
    })

    socket.on("hourSim", function (data) {
        $("[name=bant]").append("<tr class='"+(data.error?"danger":"info") + "'>" +
            "<td>"+data.time+"</td>" +
            "<td>"+data.message+"</td>" +
            "</tr>");
    })

    socket.on("daySim", function (data) {
        var daySalesTotal = 0;
        var str = '                        <div class="panel panel-default">\n' +
            '                            <div class="panel-heading">\n' +
            '                                <h4 class="panel-title">\n' +
            '                                    <a data-toggle="collapse" href="#' + data.date + '" id="' + data.date  +  'A" >'+data.date + '</a>\n' +
            '                                </h4>\n' +
            '                            </div>\n' +
            '                            <div id="'+ data.date + '" class="panel-collapse collapse"></div></div>';
        $("[name=DayPanels]").append(str);

        for(var hour = 0; hour < 24; hour++){
            var hourBasket = data.dayBaskets[hour];
            var hourSalesTotal = 0;

            var str =  "<div class='panel-heading'>" +
                        "<h3 class='panel-title'>" +
                            "<a href='#" + data.date + "-" + FormatNumberLength(hour, 2) + "-00' id='" + data.date + "-" + FormatNumberLength(hour, 2) + "-00A' data-toggle='collapse' >" + FormatNumberLength(hour, 2) + ":00</a>" +
                        "</h3>" +
                    "</div>" +
                    "<div id='" + data.date + "-" + FormatNumberLength(hour, 2) + "-00' class='panel-collapse collapse'></div>";

                    $("#"+data.date).append(str);
                        hourBasket.forEach(function (basket) {
                            if(basket) {
                                var str = "<div class='panel-body'><h6>" + FormatNumberLength(hour,2) + ":" + FormatNumberLength(basket.minute, 2) + "</h6><br>";
                                basket.items.forEach(function (item) {
                                    if(item){
                                        str+=item.fullTitle + ", Price: &pound;" + item.price.toFixed(2) + "<br>";
                                        daySalesTotal = daySalesTotal + parseFloat(item.price.toFixed(2));
                                        hourSalesTotal = hourSalesTotal + parseFloat(item.price.toFixed(2));
                                    }
                                })
                                str += "</div><hr>"
                                $("#"+data.date + "-" + FormatNumberLength(hour, 2) + "-00").append(str);
                            }
                        })
                    $("#" + data.date + "-" + FormatNumberLength(hour, 2) + "-00A").html(FormatNumberLength(hour, 2) + ":00,  £" + hourSalesTotal.toFixed(2) )



        }
        $("#" + data.date + "A").html(data.date + ",  £" + daySalesTotal.toFixed(2) )
        console.log(data);
    })


    socket.on("newLine", function (data) {
        $("[name=bant]").append("<tr class='"+(data.error?"danger":"success") + "'>" +
                                    "<td>"+data.time+"</td>" +
                                    "<td>"+data.message+"</td>" +
                                "</tr>");
        console.log(data)
    })

    var plotx = [];
    var ploty = [];


    var trace1 = {
        type: 'scatter',
        x: plotx,
        y: ploty,
        mode: 'lines',
        name: 'Red',
        line: {
            color: 'rgb(219, 64, 82)',
            width: 3
        }
    };

    var plotDraw = setInterval(function () {
        Plotly.newPlot('tester', [trace1])
    }, 500)

    socket.on("itemPick", function (data) {
        $("[name=bant]").append("<tr class='"+(data.error?"danger":"primary") + "'>" +
            "<td>"+data.time+"</td>" +
            "<td>"+data.message+"</td>" +
            "</tr>");

        plotx.push(data.dayNum);
        ploty.push(data.dayBaskets);

        trace1 = {
            type: 'scatter',
            x: plotx,
            y: ploty,
            mode: 'lines',
            name: 'Red',
            line: {
                color: 'rgb(219, 64, 82)',
                width: 3
            }
        };







        console.log(data)
    })

    function FormatNumberLength(num, length) {
        var r = "" + num;
        while (r.length < length) {
            r = "0" + r;
        }
        return r;
    }

</script>



<footer>
    <% include ./part/footer %>
</footer>

</body>
</html>